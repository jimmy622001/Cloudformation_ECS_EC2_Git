name: CloudFormation Guard

on:
  push:
    paths:
      - 'templates/**'
  pull_request:
    paths:
      - 'templates/**'

jobs:
  cfn-guard:
    name: Run CloudFormation Guard
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          
      - name: Install cfn-guard
        run: |
          cargo install cfn-guard
          
      - name: Create Basic Security Rules
        run: |
          cat > security-rules.guard << 'EOL'
          # Basic Security Rules 
          
          # Enforce encryption of S3 buckets
          rule s3_encryption when resourceType == "AWS::S3::Bucket" {
            some Properties.BucketEncryption.ServerSideEncryptionConfiguration[*].ServerSideEncryptionByDefault.SSEAlgorithm == "AES256" or
            some Properties.BucketEncryption.ServerSideEncryptionConfiguration[*].ServerSideEncryptionByDefault.SSEAlgorithm == "aws:kms"
          }
          
          # Ensure S3 buckets block public access
          rule s3_public_access_block when resourceType == "AWS::S3::Bucket" {
            Properties.PublicAccessBlockConfiguration.BlockPublicAcls == true
            Properties.PublicAccessBlockConfiguration.BlockPublicPolicy == true
            Properties.PublicAccessBlockConfiguration.IgnorePublicAcls == true
            Properties.PublicAccessBlockConfiguration.RestrictPublicBuckets == true
          }
          
          # Ensure RDS instances are encrypted
          rule rds_encryption when resourceType == "AWS::RDS::DBInstance" {
            Properties.StorageEncrypted == true
          }
          
          # Ensure security groups don't allow unrestricted access
          rule restrict_sg_ingress when resourceType == "AWS::EC2::SecurityGroup" {
            when some Properties.SecurityGroupIngress[*] {
              not (CidrIp == "0.0.0.0/0" and (FromPort == 0 or ToPort == 0 or IpProtocol == "-1"))
            }
          }
          EOL
          
      - name: Run Guard on Templates
        run: |
          for template in templates/*.yaml; do
            echo "Scanning $template"
            cfn-guard validate -r security-rules.guard -d $template --show-summary all || echo "Validation failed for $template"
          done